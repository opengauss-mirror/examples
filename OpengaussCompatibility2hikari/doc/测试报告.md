**Keywords 关键词**：HikariCP连接池，dolphin，兼容性测试

**Abstract 摘要**：本文档是对HikariCP连接池分别使用MySQL驱动和openGauss (PG)驱动连接openGauss数据库时的HikariCP全量API兼容性测试。

1.HikariCP使用PG驱动连接 openGauss 数据库，成功创建数据源并获取连接，连接池配置有效，执行测试用例152个，发现问题1个，整体兼容性良好。

2.openGauss 的MySQL协议兼容dolphin插件不完全兼容MySQL的事务隔离，HikariCP连接池通过MySQL驱动无法正确创建数据源建立有效连接。

3.连接池执行TPCH TPCDS查询语句，通过正确性测试。

#  1 概述

该测试需求的目的是检测 HikariCP 连接池与 openGauss 的兼容性，通过 MySQL 驱动和 PG 驱动连接 openGauss 数据库，利用 openGauss 常用的 DDL、DML、DCL、存储过程等语法测试连接池相关 API 接口，输出测试结果。

# 2 测试版本说明

## 2.1 测试版本信息

### 2.1.1 被测版本

| 版本名称            | 软件包名称                                  |
| ------------------- | ------------------------------------------- |
| openGauss 6.0.0-RC1 | openGauss-6.0.0-RC1-CentOS-64bit-all.tar.gz |

##  2.2 测试环境描述

### 2.2.1 环境硬件信息

| 环境信息 | 硬件型号   | 硬件配置信息                                                 | 备注 |
| -------- | ---------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | x86_CentOS | CPU：AMD Ryzen 7 7840HS w/ Radeon 780M Graphics  3.80 GHz 内存：8G 硬盘：100G OS：CentOS Linux release 7.6.1810 (Core) 文件系统：3d9e9bee-8d47-4d52-98f2-26314895928d 网卡：ens33 |      |
| 物理机   | Win11      | CPU：AMD Ryzen 7 7840HS w/ Radeon 780M Graphics  3.80 GHz 内存：16G 硬盘：512G OS：Windows 11 家庭中文版 网卡：Qualcomm WCN685x Wi-Fi 6E Dual Band Simultaneous (DBS) WiFiCx Network Adapter #3 |      |



#  3 版本概要测试结论、关键风险和规避措施

## 3.1 测试结论总结

 openGauss 的MySQL协议兼容dolphin插件不完全兼容MySQL的事务隔离，导致HikariCP连接池通过MySQL驱动无法正确创建数据源建立连接，尝试更改连接池配置connectionTestQuery规避该问题，未成功。HikariCP使用PG驱动连接 openGauss 数据库，成功创建数据源并获取连接，连接池配置有效；通过TPCH TPCDS正确性测试，执行测试用例152个，发现问题1个，整体兼容性良好。

## 3.2 约束说明

1.用例主要为openGauss常用的DDL、DML、DCL、存储过程等语法以及Dolphin语法。

2.使用MySQL驱动连接需创建B兼容数据库并使用dolphin协议。

## 3.3 关键风险和规避措施

无

#  4 版本详细测试结论

## 4.1 兼容性测试结论

### 4.1.1 HikariCP连接池兼容性评估

| 数据库驱动 | 应用说明及关键约束假设依赖 | 关键遗留事项如缺陷等                       | 测试整体覆盖情况                                             | 兼容性评估 | 主要风险 |
| ---------- | -------------------------- | ------------------------------------------ | ------------------------------------------------------------ | ---------- | -------- |
| PG驱动     | 详见3.2章节描述            | dolphin插件部分语法不兼容                  | 主要覆盖 openGauss 常用的 DDL、DML、DCL、存储过程以及dolphin语法 | ▮          |          |
| MySQL驱动  | 详见3.2章节描述            | SELECT @@session.transaction_isolation语句 | -                                                            | ●          |          |

*兼容性评估说明*：

● ： 表示兼容性较差

▲：表示基本兼容，存在少量问题

▮：表示兼容性良好



### 4.1.2 存在问题及原因分析

1. **PG驱动**

+ 连接池配置

~~~properties
dataSourceClassName=org.postgresql.ds.PGSimpleDataSource
dataSource.user=proto_test
dataSource.password=Proto_test123
dataSource.url=jdbc:postgresql://192.168.131.66:5432/utf8_db
...
~~~

+ 存在问题

| 不兼容语句                                                   | 报错信息                                                     | 原因分析                                                     | 备注            |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | --------------- |
| [delimiter //](https://docs-opengauss.osinfra.cn/zh/docs/6.0.0-RC1/docs/ExtensionReference/dolphin-CREATE-FUNCTION.html) | org.postgresql.util.PSQLException: ERROR: syntax error at end of input | JDBC不支持delimiter语句                                      | 【dolphin语法】 |
| [create procedure procxx() select a from t1;](https://docs-opengauss.osinfra.cn/zh/docs/6.0.0-RC1/docs/ExtensionReference/dolphin-CREATE-PROCEDURE.html)[set dolphin.sql_mode = 'block_return_multi_results';](https://gitee.com/opengauss/docs/blob/master/content/zh/docs/ExtensionReference/dolphin-GUC参数说明.md) | java.util.NoSuchElementException                             | 驱动视图访问不存在的结果集，驱动不支持对调用存储过程获取多个结果集的处理 | 【dolphin语法】 |

+ 小结

HikariCP连接池使用PG驱动连接openGauss数据库能够常用的DDL、DML、DCL和存储过程语句，且兼容大部分Dolphin语法，支持事务隔离，总体而言兼容性良好。长时间压测连接池性能稳定，无内存泄漏，能正常释放连接；但当池活跃连接较多时(超过90%的连接为Active Connections)，每过一个maxLifetime，池的总连接数会有小幅度波动，部分sql语句的执行被中断。

2. **MySQL驱动**

+ 连接池配置

~~~properties
jdbcUrl=jdbc:mysql://192.168.131.66:3308/utf8_db?useSSL=false&serverTimezone=Asia/Shanghai
username=proto_test
password=Proto_test123
driverClassName=com.mysql.cj.jdbc.Driver
...
connectionTestQuery=SET SESSION transaction isolation LEVEL SERIALIZABLE
~~~

+ 存在问题

因无法识别'default'隔离级别，无法从数据源创建有效连接。

~~~
16:20:10.759 [main] WARN com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Default transaction isolation level detection failed (Could not map transaction isolation 'default' to a valid JDBC level.).
16:20:10.759 [main] DEBUG com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Closing connection com.mysql.cj.jdbc.ConnectionImpl@6253c26: (Failed to create/setup connection)
16:20:10.761 [main] ERROR com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Error thrown while acquiring connection from data source
~~~

出错原因为执行查询当前连接时返回了无法识别的隔离级别'default'（可识别的级别：READ-UNCOMMITED、READ-UNCOMMITTED、READ-COMMITTED、REPEATABLE-READ和SERIALIZABLE，用于存放状态的结构HashMap区分键值的大小写）。

~~~sql
SELECT @@session.transaction_isolation
~~~

尝试通过设置连接池配置connectionTestQuery，将连接隔离级别更改为可识别状态。因为HashMap键值大小写问题，无法识别隔离级别'serializable'。

~~~
18:10:11.375 [main] WARN com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Default transaction isolation level detection failed (Could not map transaction isolation 'serializable' to a valid JDBC level.).
18:10:11.375 [main] DEBUG com.zaxxer.hikari.pool.PoolBase - HikariPool-1 - Closing connection com.mysql.cj.jdbc.ConnectionImpl@2d710f1a: (Failed to create/setup connection)
18:10:11.377 [main] ERROR com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Error thrown while acquiring connection from data source
~~~

具体故障信息如下。

|                   openGauss版本                   |                        MySQL驱动版本                         |                           故障信息                           |
| :-----------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|        openGauss 6.0.0-RC1；openGauss3.1.0        | mysql-connector-java 8.0.27以上版本；mysql-connector-j 8.2.0以上版本 |            连接池停滞在Starting...，无法正确启动             |
|        openGauss 6.0.0-RC1；openGauss3.1.0        |             mysql-connector-java 8.0.27以下版本              |              连接隔离级别为'default'，无法识别               |
| openGauss5.0.3；openGauss 5.0.2；openGauss 5.0.1  | mysql-connector-java 8.0.27以上版本；mysql-connector-j 8.2.0以上版本 |            连接池停滞在Starting...，无法正确启动             |
| openGauss 5.0.3；openGauss 5.0.2；openGauss 5.0.1 |             mysql-connector-java 8.0.27以下版本              | ERROR:  missing FROM-clause entry for table "session"。openGauss将@@session.transaction_isolation视为"session"表的引用，实际上并没有此表 |

尝试JDBC使用MySQL驱动连接数据库，能够执行sql语句。查看文档，dolphin插件似乎仍不支持MySQL的@@session.transaction_isolation语法。

+ 小结

启动dolphin插件，使用MySQL JDBC能够连接openGauss数据库，执行sql语句并返回结果。但dolphin插件似乎仍不支持MySQL的@@session.transaction_isolation语法，连接池无法通过MySQL驱动获取连接的隔离级别，故无法获取有效连接。



## 4.2 资料测试结论

使用PG驱动连接

| 序号 | 测试章节                                                   | 测试结论                        |
| ---- | ---------------------------------------------------------- | ------------------------------- |
| 1    | SQL参考>SQL语言结构和语法>SQL语法                          | 并未发现问题，整体质量良好      |
| 2    | 插件参考>Dolphin Extension>Dolphin语法介绍>SQL参考>SQL语法 | 兼容大部分sql语法，整体质量良好 |

# 5 测试对象质量评估

## 5.1 覆盖率分析

本次覆盖的数据库对象为行存表、列存表、分区表、临时表、物化视图、存储过程、函数等，主要通过执行 openGauss 常用的 DDL、DML、DCL、存储过程以及dolphin语法测试HikariCP连接池对openGauss数据库兼容性，同时使用TPCDS和TPCH作为正确性测试，检测连接池能否正确执行语句、异常情况是否有合理报错。

## 5.2 缺陷统计和分析

### 5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1        | 0    | 0    | 1    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 100% | 0%     |

### 5.2.2 缺陷列表

| 问题级别 | 问题描述                         |
| -------- | -------------------------------- |
| 次要     | 不支持存储过程调用时返回多结果集 |

# 6 测试过程评估

## 6.1 测试策略回顾

| 编号 | 特性       | 验证策略                                 | 是否按照测试策略执行 |
| ---- | ---------- | ---------------------------------------- | -------------------- |
| 1    | 正确性测试 | 执行TPCH TPCDS查询语句，执行结果符合预期 | YES                  |
| 2    | 资料测试   | 执行结果与文档描述、客户端执行结果一致   | YES                  |

## 6.2 测试设计评估

| 编号 | 测试点修改说明 | 修改原因 | 是否影响测试质量 |
| ---- | -------------- | -------- | ---------------- |
| NA   |                |          |                  |

## 6.3 测试执行评估

### 6.3.1 测试执行统计数据

| 版本名称             | 测试用例数 | 用例执行数 | 发现缺陷数 | 缺陷密度 |
| -------------------- | ---------- | ---------- | ---------- | -------- |
| openGauss 6.0.0 B012 | 152        | 152        | 1          | 0        |

说明：资料的问题单不计入缺陷密度。

### 6.3.2 测试用例执行结果统计数据

+ **自定义测试用例**

| 总测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------------ | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 31           | 31               | 30     | 1      | 0       | 0           | 100%   | 96.8%      |

| 异常用例情况                                         | 影响分析                         | 规避措施 | 后续计划 |
| ---------------------------------------------------- | -------------------------------- | -------- | -------- |
| set dolphin.sql_mode = 'block_return_multi_results'; | 不支持存储过程调用时返回多结果集 |          |          |

+ **TPCDS**

| 总测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------------ | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 99           | 99               | 99     | 0      | 0       | 0           | 100%   | 100%       |

| 异常用例情况 | 影响分析 | 规避措施 | 后续计划 |
| ------------ | -------- | -------- | -------- |
| NA           |          |          |          |

+ **TPCH**

| 总测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------------ | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 22           | 22               | 22     | 0      | 0       | 0           | 100%   | 100%       |

| 异常用例情况 | 影响分析 | 规避措施 | 后续计划 |
| ------------ | -------- | -------- | -------- |
| NA           |          |          |          |

# 7 附件

## 7.1 附件1：遗留问题列表

| 序号 | 问题单号 | 问题描述 | 分类 | 问题级别 | 问题分析与影响 | 规避措施 |
| ---- | -------- | -------- | ---- | -------- | -------------- | -------- |
| NA   |          |          |      |          |                |          |

## 7.2 附件：相关PR

