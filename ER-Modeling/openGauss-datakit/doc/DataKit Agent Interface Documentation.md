**openGauss DataKit Agent 文档**

# **关于本手册**

## **Agent介绍**
    
DataKit 在用户添加管理服务器时，可完成服务器Agent安装和启动。DataKit通过给代理Agent服务下发热问你，并由代理Agent实现任务执行。
任务类型包括：命令执行，数据采集等多种任务。具体任务定义通过任务模版方式实现。
## **主要功能介绍**

Agent主要包含以下几个功能特性：

- 通过服务器管理安装卸载Agent代理
- 任务管理，负责任务定义、存储、下发以及任务执行状态
- 任务执行引擎，支持多种类型任务执行与调度
- 数据采集，通过配置采集任务，从不同数据源采集指定数据并返回到DataKit分类存储

## **预期读者**

- 用户
- 测试人员
- 开发人员

## **版本及功能列表**

| **版本号**   | **新增功能** | **发布时间**  |
|-----------| --- |-----------|
| V7.00-RC2 | 首次发布 | 2025-9-30 |

## **Agent 任务配置规则**

### **概述**

DataKit根据任务配置规则，创建响应的任务模版。根据任务模版绑定对应Host或者DB实例，从而创建具体执行任务实例。在DataKit启动时将任务实例下发给相关代理Agent进程，完成任务执行。

### **任务模板定义**
#### 采集任务名称
任务名称不可重复，约定一个采集任务采集一组相关指标数据，并安装一致的存储策略存储在对应表中。
#### 采集任务类型

任务类型包含OSHI固定指标任务，OSHI动态指标任务，OS指标任务，DB指标任务，OS管道任务，DB管道任务
- OSHI固定指标任务，通过OSHI采集服务器固定指标任务
- OSHI动态指标任务，通过OSHI采集服务器动态指标任务
- OS指标任务，通过配置OS命令采集OS相关指标任务
- DB指标任务，通过配置数据库示例，通过SQL采集数据库相关数据
- OS管道任务，通过配置Linux命令，采集相关指定数据
#### 采集任务所属分组
对运行在Agent的采集任务进行分组。待设计
#### 采集任务所属插件
当前任务归属插件ID或者平台基座
#### 采集任务操作对象类型
任务执行对象类型，包括OSHI，OS，DB，HTTP
#### 采集任务操作对象
获取任务数据需要执行命令，可以是OS命令，查询SQL/explain语句,或者部分操作数据库命令（白名单）
- OS：sh xx.sh /python yy.py/ top / free -g 
- DB :JDBC执行对应SQL，仅支持select/explain
- OSHI: Agent内置OSHI框架，并提供部分操作系统指标数据采集实现
- HTTP：实现数据接收以及转发处理。提供固定数据接收地址，以及默认转发地址，并运行任务自定义转发地址
#### 采集任务频率
采集频率为任务执行间隔，默认单位秒，使用ISO-8601持续时间规则表示
- 频率>=0 执行单位为妙，eg. P1Y2M3W4DT5H6M7.5S
- 频率==0 任务为一次性任务，执行完任务后立即退出 eg. PT0S
- 频率==-1 任务启动后不主动退出，常驻内存，直到用户主动关闭任务 eg. PT-1S 
#### 采集任务上报指标
上报指标定义了当前任务指定采集的数据字段名称，数据描述信息，数据类型，数据单位，采集命令，属性等信息。
模板定义的采集字段详细信息通过t_task_schema_definition表绑定之间的关系。
#### 采集任务上报数据存储策略
采集任务数据存储策略包括，自定义存储策略，实时存储策略，历史存储策略，指纹存储策略，树状存储策略

- 自定义存储策略：开发者自行增加数据处理逻辑，实现数据处理。
- 实时存储策略：保持一个周期内的实时采集任务数据，不记录历史数据。指标任务数据存储在固定表agent_metric_real_time中，管道任务表根据任务动态生成相应实时数据存储表。
- 历史存储策略：保存一定历史周期内是采集任务数据。指标任务数据存储在固定表agent_metric_historical中，管道任务根据任务名称动态生成对应的历史表
- 指纹去重策略：任务收集数据按照行表存储，并增加指纹去重算法。去重必须指定相关字段名称。（待开发）
- 树状结构存储策略：动态创建专属任务数据表（待开发）
#### 采集任务上报数据保留周期
用于定期清理历史类型任务表存储的过期数据。配置格式采用ISO-8601持续时间规则表示。

#### 采集任务上报数据接收地址
数据接收地址，可选填。开发者指定其他地址，需自行处理数据接收以及数据处理逻辑。
当前支持的数据接收地址包括：
- /receive/fixed/host/info : 默认接收Host固定指标数据，并持久化到Host基本信息表
- /receive/metrics ： 默认接收DataKitOTel数据，并将指标数据存储到任务指定表中
- /receive/pipeline ： 默认接收DataKit可变类型数据，并将数据存储到任务指定表中。

